<?php

namespace App\Repositories;

use App\Entities;

/**
 * OrderRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OrderRepository extends \Doctrine\ORM\EntityRepository
{
    use \LaravelDoctrine\ORM\Pagination\PaginatesFromRequest;

    /**
     * @param Entity\Supplier $supplier
     */
    function fromSupplier(Entities\Supplier $supplier, $perPage = 5, $pageName= "page") 
    {
        $builder = $this->createQueryBuilder('o');
        $builder->andWhere('o.supplier = :id')
                ->orderBy('o.created' , 'DESC')
                ->setParameters([
                    'id' => $supplier
                ]);

        return $this->paginate($builder->getQuery(), $perPage, $pageName);
    }

    /**
     *
     */
    function search(
        $sequence = null, 
        $from = null, 
        $to = null, 
        $account = null, 
        $supplier = null, 
        $type = null, 
        $status = null, 
        $sortBy = null, 
        $sort = null, 
        $perPage = 10, 
        $pageName= "page")
    {
        $builder = $this->createQueryBuilder('o');
        //if ($sequence !== null) {
        //    $builder->andWhere("o.sequence LIKE :sequence")
        //            ->setParameter('sequence', "%{$sequence}%");
        //}
        //if ($from !== null) {
        //    $builder->andWhere("o.date >= :from")
        //        ->setParameter('from', $from);
        //}
        //if ($to !== null) {
        //    $builder->andWhere("o.date <= :to")
        //        ->setParameter('to', $to);
        //}
        //if ($account !== null) {
        //    $builder->andWhere("o.account = :account")
        //        ->setParameter('account', $account);
        //}
        //if ($supplier !== null) {
        //    $builder->andWhere("o.supplier = :supplier")
        //            ->setParameter('supplier', $supplier);
        //}
        //if ($type !== null) {
        //    $builder->innerJoin('o.account', 'a')
        //            ->andWhere("a.type = :type")
        //            ->setParameter('type', $type);
        //}
        //if ($status !== null) {
        //    $builder->andWhere("o.status = :status")
        //        ->setParameter('status', $status);
        //}

        //$builder->orderBy("o.{$sortBy}" , $sort);

        return $this->paginate($builder->getQuery(), $perPage, $pageName);
    }

    /**
     * @param Account $account
     * @return Order|null
     */
    function lastest(Entities\Account $account) 
    {
        return $this->createQueryBuilder('o')
                    ->innerJoin('o.subaccount', 's')
                    ->andWhere('s.account = :account')
                    ->setParameter('account', $account->getId())
                    ->orderBy('o.date', 'desc')
                    ->setMaxResults(1)
                    ->getQuery()
                    ->getOneOrNullResult();
    
    }
}
